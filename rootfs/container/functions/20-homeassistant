# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

homeassistant_bootstrap_filesystem() {
    create_folder \
                    "${CONFIG_PATH},\
                    ${CONIG_CUSTOM_PATH},\
                    ${DATA_PATH},\
                    ${LOG_PATH}" \
                    ${HOMEASSISTANT_USER}:${HOMEASSISTAANT_GROUP} 755

    create_logrotate homeassistant "${LOG_PATH}"/"${LOG_FILE}" homeassistant ${HOMEASSISTANT_USER} ${HOMEASSISTANT_GROUP}
}

homeassistant_configure_webserver() {
    update_template \
                    /etc/nginx/sites.available/homeassistant.conf \
                        LISTEN_PORT
}

homeassistant_generate_configuration() {
    if var_true "${ENABLE_BUILD_TOOLS}"; then
        package update
        package install \
                        BUILD_TOOLS_CORE \
                        BUILD_TOOLS_EXTRA
    fi

    if [ "${SETUP_MODE,,}" = "auto" ] ; then
        if [ ! -f "${CONFIG_PATH}"/configuration.yaml ]; then
            print_info "Generating Initial Home Assistant Configuration"
            cat <<EOF | silent sudo -u "${HOMEASSISTANT_USER}" tee "${CONFIG_PATH}"/configuration.yaml
## Home Assistant Configuration
## Generated for version ${HOMEASSISTANT_VERSION} from ${IMAGE_NAME} on $(TZ=${TIMEZONE} date +'%Y-%m-%d %H:%M:%S %Z')

frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
EOF
        fi
    fi
}
